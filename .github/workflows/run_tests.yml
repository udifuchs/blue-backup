name: run tests
on: [ push, pull_request, workflow_dispatch ]
jobs:
  linters:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.12" ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: install pip and tox
        run: |
          python -m pip install --upgrade pip
          pip install tox
      - name: run linters
        run: tox run-parallel -e mypy,pep8,pylint,ruff,typos
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Run on earliest and latest supported python versions.
        # But setuptools 77.0.3 requires python >= 3.9
        python-version: [ "3.9", "3.14" ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: setup ssh for tests
        run: |
          sudo ssh-keygen -t "rsa" -f ~root/.ssh/id_rsa -N ""
          sudo cp ~root/.ssh/{id_rsa.pub,authorized_keys}
          # Permanently added '127.0.0.1' to the list of known hosts:
          sudo ssh -o "StrictHostKeyChecking no" 127.0.0.1
      - name: install tox
        run: sudo apt install tox
      - name: run pytest
        # Mounting the btrfs partition requires sudo:
        run: sudo tox run -e py3,no-paramiko
